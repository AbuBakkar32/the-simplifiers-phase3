<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>W1 — Nightingale Rose Chart</title>
<link rel="stylesheet" href="assets/style.css"/>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="assets/app.js"></script></head>
<body>
<div class="wrap">
<header>
  <div class="title"><h1>W1 — Nightingale Rose Chart</h1><p>Polar chart of <b>mean CO₂</b> per <b>environment type</b>. Use step range to see local changes along the route.</p></div>
  <div class="badges"><div class="badge" id="badge">Loading dataset…</div></div>
</header>

<div id="errorBox" class="card" style="display:none;border-color:rgba(251,113,133,0.35)"></div>

<nav class="nav"><a class="" href="index.html">Dashboard</a>
<a class="active" href="w1_nightingale.html">W1 Nightingale</a>
<a class="" href="w2_network.html">W2 Network</a>
<a class="" href="w3_sankey.html">W3 Sankey</a>
<a class="" href="w4_rankribbons.html">W4 Rank Ribbons</a>
<a class="" href="w5_treemap.html">W5 Treemap</a></nav>

<div class="card"><div class="controls" style="grid-template-columns:1fr 1fr">
  <div><label>Start step</label><input id="start" type="range"/></div>
  <div><label>End step <span class="small" id="rangeLabel" style="float:right"></span></label><input id="end" type="range"/></div>
</div>
<p class="small" style="margin:10px 0 0">Polar petals show which environments have higher average CO₂ in the selected steps.</p></div>

<div class="section">
  <h2>Visualization</h2>
  <div class="card"><div id="plot" class="plot tall"></div></div>
</div>

<div class="footer">Variables used: <span class="code">step, env_type, co2_ppm</span></div>
</div>

<script>(async function(){
  await loadDataset();
  const sEl=document.getElementById("start"), eEl=document.getElementById("end"), lbl=document.getElementById("rangeLabel");
  sEl.min=APP.meta.minStep; sEl.max=APP.meta.maxStep; sEl.value=APP.meta.minStep;
  eEl.min=APP.meta.minStep; eEl.max=APP.meta.maxStep; eEl.value=APP.meta.maxStep;
  function render(){
    let s=Number(sEl.value), e=Number(eEl.value);
    if(s>e){ const t=s; s=e; e=t; sEl.value=s; eEl.value=e; }
    lbl.textContent=`steps ${s}–${e}`;
    const rows=applyFilters({s,e}).filter(r=>r.co2_ppm!==null);
    const envs=uniq(rows.map(v=>v.env_type));
    const mean={}, cnt={}; envs.forEach(k=>{mean[k]=0;cnt[k]=0;});
    rows.forEach(r=>{ mean[r.env_type]+=r.co2_ppm; cnt[r.env_type]+=1; });
    const theta=[], rvals=[], hover=[];
    envs.forEach(k=>{
      const m=cnt[k]? mean[k]/cnt[k]:0;
      theta.push(k); rvals.push(m);
      hover.push(`${k}<br>Mean CO₂: ${Math.round(m)} ppm<br>Records: ${cnt[k]}<extra></extra>`);
    });
    Plotly.react("plot",[{
      type:"barpolar",theta,r:rvals,hovertemplate:hover,
      marker:{color:rvals,colorscale:"Turbo",line:{color:"rgba(255,255,255,0.22)",width:1}}
    }],{
      title:"Nightingale Rose — Mean CO₂ by Environment",
      height:720,margin:{l:20,r:20,t:60,b:20},
      paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:"rgba(245,248,255,0.92)"},
      polar:{bgcolor:"rgba(0,0,0,0)",
        radialaxis:{ticksuffix:" ppm",gridcolor:"rgba(255,255,255,0.10)",linecolor:"rgba(255,255,255,0.14)"},
        angularaxis:{gridcolor:"rgba(255,255,255,0.08)",linecolor:"rgba(255,255,255,0.12)"}}
    },{responsive:true});
  }
  sEl.addEventListener("input",render); eEl.addEventListener("input",render); render();
})();</script>
</body>
</html>
